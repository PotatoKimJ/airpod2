<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì½©í•œìª½ â€” ìƒì–´ë²„ë¦° ì—ì–´íŒŸì„ ê±´ ìš´ëª…ì˜ ê²Œì„</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #1a0f0f;
      --bg-gradient: radial-gradient(120% 120% at 10% 10%, #2d1515 0%, #1a0f0f 40%, #0d0808 100%);
      --surface: rgba(255, 255, 255, 0.08);
      --surface-strong: rgba(255, 255, 255, 0.12);
      --ink: #f5e6e6;
      --muted: #a08080;
      --brand: #c0392b;
      --brand-strong: #922b21;
      --border: rgba(160, 80, 80, 0.2);
      --shadow: 0 30px 80px rgba(80, 20, 20, 0.35);
      --radius-lg: 32px;
      --radius-md: 20px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      background-image: var(--bg-gradient);
      color: var(--ink);
      min-height: 100vh;
      padding: 16px;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 280px;
      height: 280px;
      background: linear-gradient(140deg, rgba(192, 57, 43, 0.25), rgba(146, 43, 33, 0.2));
      filter: blur(100px);
      z-index: -2;
      transform: translate(-50%, -50%);
    }
    body::before { top: 16%; left: 10%; }
    body::after { bottom: -8%; right: -6%; }

    .page { display: none; }
    .page.active { display: block; }

    .shell {
      max-width: 560px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .shell.match,
    .shell.destiny { justify-content: flex-start; padding: 24px 0; }
    .shell.destiny { text-align: center; }

    .hero-copy { text-align: center; margin-bottom: 32px; }
    .hero-copy h1 {
      font-size: clamp(1.75rem, 5vw, 2.25rem);
      line-height: 1.3;
      letter-spacing: -0.5px;
      margin: 0 0 28px;
      font-weight: 900;
    }
    .hero-copy h1 span { color: var(--brand-strong); }

    .hero-ctas { display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; }
    .hero-ctas a {
      display: inline-block;
      padding: 18px 32px;
      border-radius: 16px;
      font-size: 1.05rem;
      font-weight: 700;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hero-ctas .primary {
      background: linear-gradient(130deg, var(--brand-strong), var(--brand));
      color: #fff;
      box-shadow: 0 16px 35px rgba(91, 95, 251, 0.35);
    }
    .hero-ctas .primary:hover { transform: translateY(-2px); }

    .hero-panel {
      background: var(--surface-strong);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      color: var(--ink);
    }
    .hero-panel h2 { font-size: 1.1rem; margin: 0 0 16px; font-weight: 700; }

    .preview-list { display: grid; gap: 10px; }
    .preview-card {
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--ink);
    }
    .preview-card .badge {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--brand-strong);
      background: rgba(91, 95, 251, 0.12);
      font-size: 0.9rem;
    }
    .preview-card p { margin: 0; font-weight: 600; font-size: 0.95rem; }
    .preview-card span { display: block; font-size: 0.8rem; color: var(--muted); margin-top: 2px; }

    a.back { color: var(--muted); text-decoration: none; font-size: 0.9rem; display: inline-block; margin-bottom: 24px; }
    a.back:hover { color: var(--ink); }

    .panel {
      background: var(--surface-strong);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }
    .panel h1 { font-size: 1.5rem; margin: 0 0 24px; font-weight: 700; }
    .panel h2 { font-size: 1.1rem; margin: 0 0 16px; font-weight: 700; }

    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.9rem; margin-bottom: 6px; color: var(--muted); }
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.2);
      color: var(--ink);
      font-size: 1rem;
    }
    input::placeholder, textarea::placeholder { color: var(--muted); }

    button.primary {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(130deg, var(--brand-strong), var(--brand));
      color: #fff;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }
    button.primary:hover { opacity: 0.95; }

    .result-area { display: none; }
    .result-area.visible { display: block; }
    .result-card {
      padding: 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      margin-bottom: 16px;
    }
    .result-card p { margin: 0 0 8px; }
    .result-card p:last-child { margin-bottom: 0; }

    a.btn-game, a.btn-again {
      display: inline-block;
      padding: 16px 32px;
      border-radius: 14px;
      background: linear-gradient(130deg, var(--brand-strong), var(--brand));
      color: #fff;
      text-decoration: none;
      font-weight: 700;
      margin-top: 16px;
    }
    a.btn-game:hover, a.btn-again:hover { opacity: 0.95; }
    a.btn-again { padding: 14px 28px; border-radius: 12px; }

    .score-board {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 32px;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .score-board span { color: var(--brand-strong); }

    .choices { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; }
    .choice-btn {
      padding: 20px 28px;
      border-radius: 16px;
      border: 2px solid var(--border);
      background: var(--surface);
      color: var(--ink);
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .choice-btn:hover {
      border-color: var(--brand);
      background: var(--surface-strong);
    }

    .round-info { font-size: 1rem; color: var(--muted); margin-bottom: 16px; }
    .result-msg { font-size: 1.25rem; font-weight: 700; margin: 16px 0; min-height: 28px; }

    .final-panel {
      display: none;
      background: var(--surface-strong);
      border-radius: var(--radius-lg);
      padding: 32px;
      border: 1px solid var(--border);
      margin-top: 24px;
    }
    .final-panel.visible { display: block; }
    .final-panel h2 { margin: 0 0 16px; font-size: 1.5rem; }
    .final-panel.win h2 { color: #4ade80; }
    .final-panel.lose h2 { color: #f87171; }
    .final-panel.draw h2 { color: var(--muted); }

    .shell.realtime { justify-content: flex-start; padding: 24px 0; text-align: center; }
    .realtime-status { font-size: 1.1rem; color: var(--muted); margin: 24px 0; min-height: 1.5em; }
    .realtime-status.found { color: var(--brand); font-weight: 700; }
    .realtime .choice-btn { margin: 4px; }
    .realtime .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .realtime-waiting { color: var(--muted); font-size: 0.95rem; margin-top: 8px; }

    @media (min-width: 480px) {
      body { padding: 24px; }
      .shell { max-width: 520px; }
      .hero-panel, .panel { padding: 28px; }
    }
  </style>
</head>
<body>
  <!-- ë©”ì¸ -->
  <div id="page-main" class="page active">
    <div class="shell">
      <main>
        <section class="hero-copy">
          <h1><span>ì½©í•œìª½</span><br>ìƒì–´ë²„ë¦° ì—ì–´íŒŸì„ ê±´ ìš´ëª…ì˜ ê²Œì„</h1>
          <div class="hero-ctas">
            <a class="primary nav-link" href="#" data-page="match">AI ë§¤ì¹­í•˜ê¸° (ë°ëª¨)</a>
            <a class="primary nav-link" href="#" data-page="realtime">ì‹¤ì‹œê°„ ëŒ€ì „</a>
          </div>
        </section>
        <article class="hero-panel">
          <h2>ì˜¤ëŠ˜ ë§¤ì¹­ ëŒ€ê¸° í˜„í™©</h2>
          <div class="preview-list">
            <div class="preview-card">
              <div class="badge">L</div>
              <div>
                <p>AirPods Pro (2ì„¸ëŒ€, USB-C) Â· ì¢Œì¸¡ í•œ ìª½</p>
                <span>"ë…¸ì´ì¦ˆìº”ìŠ¬ë§ ë‹¤ì‹œ ëŠë¼ê³  ì‹¶ì–´ìš”"</span>
              </div>
            </div>
            <div class="preview-card">
              <div class="badge">R</div>
              <div>
                <p>AirPods (3ì„¸ëŒ€) Â· ìš°ì¸¡ í•œ ìª½</p>
                <span>"ë°˜ìª½ì´ë¼ BGMì´ ìš¸ë ¤ìš” ğŸ˜¢"</span>
              </div>
            </div>
            <div class="preview-card">
              <div class="badge">L</div>
              <div>
                <p>AirPods Pro (1ì„¸ëŒ€) Â· ì¢Œì¸¡ í•œ ìª½</p>
                <span>"ìš´ëª…ì˜ ì§ì„ ì°¾ê³  ì‹¶ì–´ìš”"</span>
              </div>
            </div>
          </div>
        </article>
      </main>
    </div>
  </div>

  <!-- AI ë§¤ì¹­ -->
  <div id="page-match" class="page">
    <div class="shell match">
      <a href="#" class="back nav-link" data-page="main">â† ë©”ì¸ìœ¼ë¡œ</a>
      <div class="panel">
        <h1>AI ë§¤ì¹­</h1>
        <form id="matchForm">
          <div class="form-group">
            <label>ëª¨ë¸</label>
            <select name="model" required>
              <option value="">ì„ íƒ</option>
              <option value="1gen">AirPods (1ì„¸ëŒ€)</option>
              <option value="2gen">AirPods (2ì„¸ëŒ€)</option>
              <option value="3gen">AirPods (3ì„¸ëŒ€)</option>
              <option value="pro1">AirPods Pro (1ì„¸ëŒ€)</option>
              <option value="pro2-lightning">AirPods Pro (2ì„¸ëŒ€, Lightning)</option>
              <option value="pro2-usbc">AirPods Pro (2ì„¸ëŒ€, USB-C)</option>
            </select>
          </div>
          <div class="form-group">
            <label>ë°©í–¥</label>
            <select name="side" required>
              <option value="">ì„ íƒ</option>
              <option value="L">ì¢Œì¸¡ (L)</option>
              <option value="R">ìš°ì¸¡ (R)</option>
            </select>
          </div>
          <div class="form-group">
            <label>ì»¨ë””ì…˜</label>
            <input type="text" name="condition" placeholder="ì˜ˆ: ê±°ì˜ ìƒˆê²ƒ" required>
          </div>
          <div class="form-group">
            <label>ì‚¬ìš©ê¸°ê°„</label>
            <input type="text" name="duration" placeholder="ì˜ˆ: 6ê°œì›”" required>
          </div>
          <button type="submit" class="primary">ë§¤ì¹­ ëŒë ¤ë³´ê¸°</button>
        </form>
      </div>
      <div class="panel result-area" id="resultArea">
        <h2>ë§¤ì¹­ ê²°ê³¼</h2>
        <div class="result-card" id="resultCard"></div>
        <a href="#" class="btn-game nav-link" id="btnGame" data-page="destiny" style="display:none;">ê²Œì„ ì…ì¥í•˜ê¸°</a>
      </div>
    </div>
  </div>

  <!-- ìš´ëª…ì˜ ê²Œì„ -->
  <div id="page-destiny" class="page">
    <div class="shell destiny">
      <a href="#" class="back nav-link" data-page="main">â† ë©”ì¸ìœ¼ë¡œ</a>
      <h1>ìš´ëª…ì˜ ê²Œì„ â€” ë‹¨íŒ ê°€ìœ„ë°”ìœ„ë³´</h1>
      <div class="score-board">
        <span>ë‚˜: <span id="myScore">0</span></span>
        <span>ìƒëŒ€: <span id="oppScore">0</span></span>
      </div>
      <div class="round-info" id="roundInfo">1íŒ</div>
      <div class="result-msg" id="resultMsg"></div>
      <div class="choices">
        <button class="choice-btn" data-choice="ê°€ìœ„">ê°€ìœ„</button>
        <button class="choice-btn" data-choice="ë°”ìœ„">ë°”ìœ„</button>
        <button class="choice-btn" data-choice="ë³´">ë³´</button>
      </div>
      <div class="final-panel" id="finalPanel">
        <h2 id="finalTitle"></h2>
        <p id="finalDesc"></p>
        <a href="#" class="btn-again" id="btnAgain">ë‹¤ì‹œ í•˜ê¸°</a>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ ëŒ€ì „ -->
  <div id="page-realtime" class="page">
    <div class="shell realtime">
      <a href="#" class="back nav-link" data-page="main">â† ë©”ì¸ìœ¼ë¡œ</a>
      <h1>ì‹¤ì‹œê°„ ëŒ€ì „</h1>
      <div id="realtimeStatus" class="realtime-status">ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...</div>
      <div id="realtimeGame" style="display:none;">
        <div class="score-board">
          <span>ë‚˜: <span id="rtMyScore">0</span></span>
          <span>ìƒëŒ€: <span id="rtOppScore">0</span></span>
        </div>
        <div class="round-info" id="rtRoundInfo">1íŒ</div>
        <div class="result-msg" id="rtResultMsg"></div>
        <div class="choices" id="rtChoices">
          <button type="button" class="choice-btn rt-choice" data-choice="ê°€ìœ„">ê°€ìœ„</button>
          <button type="button" class="choice-btn rt-choice" data-choice="ë°”ìœ„">ë°”ìœ„</button>
          <button type="button" class="choice-btn rt-choice" data-choice="ë³´">ë³´</button>
        </div>
        <div class="realtime-waiting" id="rtWaiting" style="display:none;">ìƒëŒ€ ì„ íƒ ëŒ€ê¸° ì¤‘...</div>
      </div>
      <div id="realtimeFinal" class="final-panel" style="display:none;">
        <h2 id="rtFinalTitle"></h2>
        <p id="rtFinalDesc"></p>
        <a href="#" class="btn-again nav-link" data-page="main">ë©”ì¸ìœ¼ë¡œ</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase ì„¤ì • (https://supabase.com ì—ì„œ í”„ë¡œì íŠ¸ ìƒì„± í›„ ê°’ ì…ë ¥)
    const SUPABASE_URL = 'https://alykgcbelypjpjparqnv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFseWtnY2JlbHlwanBqcGFycW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNzg5MzcsImV4cCI6MjA4NTc1NDkzN30.TUWFWWgq02DRxTdlwC0YsvTPWdVThV_mz1kVbA7sKDY';

    const modelNames = {
      '1gen': 'AirPods (1ì„¸ëŒ€)',
      '2gen': 'AirPods (2ì„¸ëŒ€)',
      '3gen': 'AirPods (3ì„¸ëŒ€)',
      'pro1': 'AirPods Pro (1ì„¸ëŒ€)',
      'pro2-lightning': 'AirPods Pro (2ì„¸ëŒ€, Lightning)',
      'pro2-usbc': 'AirPods Pro (2ì„¸ëŒ€, USB-C)'
    };
    const sideNames = { L: 'ì¢Œì¸¡', R: 'ìš°ì¸¡' };

    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
    }

    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = this.dataset.page;
        if (page) showPage(page);
      });
    });

    document.getElementById('matchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      document.getElementById('resultCard').innerHTML = `
        <p><strong>${modelNames[fd.get('model')]} Â· ${sideNames[fd.get('side')]} í•œ ìª½</strong></p>
        <p>ì»¨ë””ì…˜: ${fd.get('condition')}</p>
        <p>ì‚¬ìš©ê¸°ê°„: ${fd.get('duration')}</p>
        <p style="color:var(--brand); margin-top:12px;">ë§¤ì¹­ ì™„ë£Œ! ìš´ëª…ì˜ ê²Œì„ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.</p>
      `;
      document.getElementById('resultArea').classList.add('visible');
      document.getElementById('btnGame').style.display = 'inline-block';
    });

    const choices = ['ê°€ìœ„', 'ë°”ìœ„', 'ë³´'];
    let myScore = 0, oppScore = 0, round = 1;
    const myScoreEl = document.getElementById('myScore');
    const oppScoreEl = document.getElementById('oppScore');
    const roundInfo = document.getElementById('roundInfo');
    const resultMsg = document.getElementById('resultMsg');
    const finalPanel = document.getElementById('finalPanel');
    const finalTitle = document.getElementById('finalTitle');
    const finalDesc = document.getElementById('finalDesc');
    const choicesEl = document.querySelector('#page-destiny .choices');

    function resetDestiny() {
      myScore = oppScore = 0;
      round = 1;
      myScoreEl.textContent = '0';
      oppScoreEl.textContent = '0';
      roundInfo.textContent = '1íŒ';
      roundInfo.style.display = '';
      resultMsg.textContent = '';
      finalPanel.classList.remove('visible', 'win', 'lose', 'draw');
      choicesEl.style.display = 'flex';
    }

    document.getElementById('btnAgain').addEventListener('click', function(e) {
      e.preventDefault();
      resetDestiny();
    });

    document.querySelectorAll('.choice-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const my = this.dataset.choice;
        const opp = choices[Math.floor(Math.random() * 3)];
        let res = '';
        if (my === opp) res = 'ë¬´ìŠ¹ë¶€';
        else if ((my === 'ê°€ìœ„' && opp === 'ë³´') || (my === 'ë°”ìœ„' && opp === 'ê°€ìœ„') || (my === 'ë³´' && opp === 'ë°”ìœ„')) {
          myScore++; res = 'ìŠ¹ë¦¬!';
        } else {
          oppScore++; res = 'íŒ¨ë°°';
        }
        myScoreEl.textContent = myScore;
        oppScoreEl.textContent = oppScore;
        resultMsg.textContent = `ë‚˜: ${my} vs ìƒëŒ€: ${opp} â†’ ${res}`;
        choicesEl.style.display = 'none';
        roundInfo.style.display = 'none';
        finalPanel.classList.add('visible');
        if (myScore > oppScore) {
          finalPanel.classList.add('win');
          finalPanel.classList.remove('lose', 'draw');
          finalTitle.textContent = 'ìŠ¹ë¦¬!';
          finalDesc.textContent = 'ìš´ëª…ì˜ ì§ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.';
        } else if (myScore < oppScore) {
          finalPanel.classList.add('lose');
          finalPanel.classList.remove('win', 'draw');
          finalTitle.textContent = 'íŒ¨ë°°';
          finalDesc.textContent = 'ë‹¤ì‹œ ê¸°íšŒë¥¼ ë…¸ë ¤ë³´ì„¸ìš”.';
        } else {
          finalPanel.classList.add('draw');
          finalPanel.classList.remove('win', 'lose');
          finalTitle.textContent = 'ë¬´ìŠ¹ë¶€';
          finalDesc.textContent = 'ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”.';
        }
      });
    });

    // ---------- ì‹¤ì‹œê°„ ëŒ€ì „ (Supabase) ----------
    const CHOICES = ['ê°€ìœ„', 'ë°”ìœ„', 'ë³´'];
    function getMyKey() {
      let k = localStorage.getItem('kong_key');
      if (!k) {
        k = 'k_' + Math.random().toString(36).slice(2) + '_' + Date.now();
        localStorage.setItem('kong_key', k);
      }
      return k;
    }
    function computeResult(my, opp) {
      if (my === opp) return 'draw';
      if ((my === 'ê°€ìœ„' && opp === 'ë³´') || (my === 'ë°”ìœ„' && opp === 'ê°€ìœ„') || (my === 'ë³´' && opp === 'ë°”ìœ„')) return 'win';
      return 'lose';
    }

    let realtimeRoomId = null;
    let realtimeUnsub = [];

    function leaveRealtime() {
      realtimeUnsub.forEach(ch => { try { ch.unsubscribe(); } catch(e) {} });
      realtimeUnsub.length = 0;
      realtimeRoomId = null;
      document.getElementById('realtimeStatus').textContent = 'ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...';
      document.getElementById('realtimeStatus').classList.remove('found');
      document.getElementById('realtimeGame').style.display = 'none';
      document.getElementById('realtimeFinal').style.display = 'none';
    }

    async function startRealtime() {
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        document.getElementById('realtimeStatus').textContent = 'Supabase URL/í‚¤ë¥¼ ì„¤ì •í•´ ì£¼ì„¸ìš”. (index.html ìƒë‹¨)';
        return;
      }
      leaveRealtime();
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const myKey = getMyKey();

      let { data: queue } = await supabase.from('matchmaking').select('*').eq('id', 1).single();
      if (queue && queue.player1_key && queue.player2_key) {
        await supabase.from('matchmaking').update({ player1_key: null, player2_key: null, updated_at: new Date().toISOString() }).eq('id', 1);
        queue = { ...queue, player1_key: null, player2_key: null };
      }
      if (queue && queue.player1_key && !queue.player2_key && queue.player1_key !== myKey) {
        await supabase.from('matchmaking').update({ player2_key: myKey, updated_at: new Date().toISOString() }).eq('id', 1);
      } else if (!queue || !queue.player1_key) {
        await supabase.from('matchmaking').update({ player1_key: myKey, updated_at: new Date().toISOString() }).eq('id', 1);
      } else if (queue.player1_key === myKey) {
        // ì´ë¯¸ ëŒ€ê¸° ì¤‘
      } else {
        document.getElementById('realtimeStatus').textContent = 'ëŒ€ê¸°ì—´ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        return;
      }

      const chQueue = supabase.channel('queue').on('postgres_changes', { event: '*', schema: 'public', table: 'matchmaking', filter: 'id=eq.1' }, async (payload) => {
        const r = payload.new;
        if (!r || !r.player1_key || !r.player2_key) return;
        const p1 = r.player1_key;
        const p2 = r.player2_key;
        if (p1 !== myKey && p2 !== myKey) return;
        if (p1 === myKey) {
          const { data: room } = await supabase.from('rooms').insert({ player1_key: p1, player2_key: p2, round: 1, status: 'playing' }).select('id').single();
          if (room) {
            await supabase.from('matchmaking').update({ player1_key: null, player2_key: null }).eq('id', 1);
            enterRoom(supabase, room.id, myKey, p1, p2);
          }
        }
      });
      chQueue.subscribe();
      realtimeUnsub.push(chQueue);

      const chRooms = supabase.channel('my_rooms').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'rooms' }, async (payload) => {
        const r = payload.new;
        if (r && (r.player1_key === myKey || r.player2_key === myKey)) {
          realtimeUnsub.forEach(ch => { try { ch.unsubscribe(); } catch(e) {} });
          realtimeUnsub.length = 0;
          enterRoom(supabase, r.id, myKey, r.player1_key, r.player2_key);
        }
      });
      chRooms.subscribe();
      realtimeUnsub.push(chRooms);

      setTimeout(async () => {
        const { data: q } = await supabase.from('matchmaking').select('*').eq('id', 1).single();
        if (q && q.player1_key && q.player2_key && (q.player1_key === myKey || q.player2_key === myKey)) {
          const { data: existing } = await supabase.from('rooms').select('id').or(`player1_key.eq.${myKey},player2_key.eq.${myKey}`).order('created_at', { ascending: false }).limit(1).single();
          if (existing) enterRoom(supabase, existing.id, myKey, q.player1_key, q.player2_key);
        }
      }, 500);
    }

    function enterRoom(supabase, roomId, myKey, p1Key, p2Key) {
      realtimeUnsub.forEach(ch => { try { ch.unsubscribe(); } catch(e) {} });
      realtimeUnsub.length = 0;
      realtimeRoomId = roomId;
      const amPlayer1 = p1Key === myKey;
      document.getElementById('realtimeStatus').textContent = 'ìƒëŒ€ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!';
      document.getElementById('realtimeStatus').classList.add('found');
      document.getElementById('realtimeGame').style.display = 'block';

      const rtMyScoreEl = document.getElementById('rtMyScore');
      const rtOppScoreEl = document.getElementById('rtOppScore');
      const rtRoundInfo = document.getElementById('rtRoundInfo');
      const rtResultMsg = document.getElementById('rtResultMsg');
      const rtChoices = document.getElementById('rtChoices');
      const rtWaiting = document.getElementById('rtWaiting');
      const rtFinal = document.getElementById('realtimeFinal');
      const rtFinalTitle = document.getElementById('rtFinalTitle');
      const rtFinalDesc = document.getElementById('rtFinalDesc');

      function renderRoom(room) {
        const myScore = amPlayer1 ? room.p1_score : room.p2_score;
        const oppScore = amPlayer1 ? room.p2_score : room.p1_score;
        rtMyScoreEl.textContent = myScore;
        rtOppScoreEl.textContent = oppScore;
        rtRoundInfo.textContent = '1íŒ';
        const myChoice = amPlayer1 ? room.p1_choice : room.p2_choice;
        const oppChoice = amPlayer1 ? room.p2_choice : room.p1_choice;
        if (room.status === 'done') {
          rtChoices.style.display = 'none';
          rtWaiting.style.display = 'none';
          rtFinal.style.display = 'block';
          if (myScore > oppScore) {
            rtFinalTitle.textContent = 'ìŠ¹ë¦¬!';
            rtFinalDesc.textContent = 'ìš´ëª…ì˜ ì§ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.';
            rtFinal.className = 'final-panel visible win';
          } else if (myScore < oppScore) {
            rtFinalTitle.textContent = 'íŒ¨ë°°';
            rtFinalDesc.textContent = 'ë‹¤ìŒ ê¸°íšŒë¥¼ ë…¸ë ¤ë³´ì„¸ìš”.';
            rtFinal.className = 'final-panel visible lose';
          } else {
            rtFinalTitle.textContent = 'ë¬´ìŠ¹ë¶€';
            rtFinalDesc.textContent = 'ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”.';
            rtFinal.className = 'final-panel visible draw';
          }
          return;
        }
        const bothChose = room.p1_choice && room.p2_choice;
        if (bothChose) {
          rtResultMsg.textContent = 'ë‚˜: ' + myChoice + ' vs ìƒëŒ€: ' + oppChoice;
          rtChoices.style.display = 'none';
          rtWaiting.style.display = 'block';
        } else {
          rtChoices.style.display = 'flex';
          rtWaiting.style.display = 'none';
          rtChoices.querySelectorAll('.rt-choice').forEach(btn => btn.disabled = !!myChoice);
          if (!myChoice) rtResultMsg.textContent = '';
        }
      }

      supabase.from('rooms').select('*').eq('id', roomId).single().then(({ data }) => { if (data) renderRoom(data); });

      const chRoom = supabase.channel('room_' + roomId).on('postgres_changes', { event: '*', schema: 'public', table: 'rooms', filter: 'id=eq.' + roomId }, (payload) => {
        if (payload.new) renderRoom(payload.new);
      });
      chRoom.subscribe();
      realtimeUnsub.push(chRoom);

      rtChoices.querySelectorAll('.rt-choice').forEach(btn => {
        btn.onclick = async () => {
          const choice = btn.dataset.choice;
          if (amPlayer1) {
            await supabase.from('rooms').update({ p1_choice: choice }).eq('id', roomId);
          } else {
            await supabase.from('rooms').update({ p2_choice: choice }).eq('id', roomId);
          }
          const { data: room } = await supabase.from('rooms').select('*').eq('id', roomId).single();
          if (room && room.p1_choice && room.p2_choice && amPlayer1) {
            const res = computeResult(room.p1_choice, room.p2_choice);
            let ns1 = room.p1_score, ns2 = room.p2_score;
            if (res === 'win') ns1++; else if (res === 'lose') ns2++;
            await supabase.from('rooms').update({
              p1_score: ns1,
              p2_score: ns2,
              status: 'done'
            }).eq('id', roomId);
          }
        };
      });
    }

    document.querySelectorAll('.nav-link[data-page="realtime"]').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        showPage('realtime');
        startRealtime();
      });
    });

    document.getElementById('page-realtime').addEventListener('click', function(e) {
      if (e.target.classList.contains('nav-link') && e.target.dataset.page === 'main') leaveRealtime();
    });
  </script>
</body>
</html>
